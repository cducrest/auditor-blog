"use strict";(self.webpackChunkminimal_blog=self.webpackChunkminimal_blog||[]).push([[429],{4765:function(e,n,t){t.d(n,{F:function(){return g},Z:function(){return A}});var a=t(7294),o=t(8733),r=t(795),l=t(6e3),s=t(6799),i=t(8871);var d=e=>{let{post:n}=e;return null};const c=["16px","8px","4px"].map((e=>"rgba(0, 0, 0, 0.1) 0px "+e+" "+e+" 0px"));var u=e=>{let{data:{post:n},children:t}=e;return(0,o.tZ)(l.Z,null,(0,o.tZ)(r.X6,{as:"h1",variant:"styles.h1"},n.title),(0,o.tZ)("p",{sx:{color:"secondary",mt:3,a:{color:"secondary"},fontSize:[1,1,2]}},(0,o.tZ)("time",null,n.date),n.tags&&(0,o.tZ)(a.Fragment,null," — ",(0,o.tZ)(s.Z,{tags:n.tags})),n.timeToRead&&" — ",n.timeToRead&&(0,o.tZ)("span",null,n.timeToRead," min read")),(0,o.tZ)("section",{sx:{my:5,".gatsby-resp-image-wrapper":{my:[4,4,5],borderRadius:"4px",boxShadow:c.join(", "),".gatsby-resp-image-image":{borderRadius:"4px"}},variant:"layout.content"}},t),(0,o.tZ)(d,{post:n}))};const g=e=>{var n,t,a;let{data:{post:r}}=e;return(0,o.tZ)(i.Z,{title:r.title,description:r.description?r.description:r.excerpt,image:r.banner?null===(n=r.banner)||void 0===n||null===(t=n.childImageSharp)||void 0===t||null===(a=t.resize)||void 0===a?void 0:a.src:void 0,pathname:r.slug,canonicalUrl:r.canonicalUrl})};function A(e){let{...n}=e;return a.createElement(u,n)}},6799:function(e,n,t){var a=t(8733),o=t(7294),r=t(1883),l=t(3494),s=t(9706);n.Z=e=>{let{tags:n}=e;const{tagsPath:t,basePath:i}=(0,l.Z)();return(0,a.tZ)(o.Fragment,null,n.map(((e,n)=>(0,a.tZ)(o.Fragment,{key:e.slug},!!n&&", ",(0,a.tZ)(r.Link,{sx:e=>{var n;return{...null===(n=e.styles)||void 0===n?void 0:n.a}},to:(0,s.Z)("/"+i+"/"+t+"/"+e.slug)},e.name)))))}},8871:function(e,n,t){var a=t(7294),o=t(1883),r=t(4232);n.Z=e=>{let{title:n="",description:t="",pathname:l="",image:s="",children:i=null,canonicalUrl:d=""}=e;const c=(0,r.Z)(),{siteTitle:u,siteTitleAlt:g,siteUrl:A,siteDescription:p,siteImage:m,author:h,siteLanguage:b}=c,k={title:n?n+" | "+u:g,description:t||p,url:""+A+(l||""),image:""+A+(s||m)};return a.createElement(a.Fragment,null,a.createElement("html",{lang:b}),a.createElement("title",null,k.title),a.createElement("meta",{name:"description",content:k.description}),a.createElement("meta",{name:"image",content:k.image}),a.createElement("meta",{property:"og:title",content:k.title}),a.createElement("meta",{property:"og:url",content:k.url}),a.createElement("meta",{property:"og:description",content:k.description}),a.createElement("meta",{property:"og:image",content:k.image}),a.createElement("meta",{property:"og:type",content:"website"}),a.createElement("meta",{property:"og:image:alt",content:k.description}),a.createElement("meta",{name:"twitter:card",content:"summary_large_image"}),a.createElement("meta",{name:"twitter:title",content:k.title}),a.createElement("meta",{name:"twitter:url",content:k.url}),a.createElement("meta",{name:"twitter:description",content:k.description}),a.createElement("meta",{name:"twitter:image",content:k.image}),a.createElement("meta",{name:"twitter:image:alt",content:k.description}),a.createElement("meta",{name:"twitter:creator",content:h}),a.createElement("meta",{name:"gatsby-theme",content:"@lekoarts/gatsby-theme-minimal-blog"}),a.createElement("link",{rel:"icon",type:"image/png",sizes:"32x32",href:(0,o.withPrefix)("/favicon-32x32.png")}),a.createElement("link",{rel:"icon",type:"image/png",sizes:"16x16",href:(0,o.withPrefix)("/favicon-16x16.png")}),a.createElement("link",{rel:"apple-touch-icon",sizes:"180x180",href:(0,o.withPrefix)("/apple-touch-icon.png")}),d?a.createElement("link",{rel:"canonical",href:d}):null,i)}},9246:function(e,n,t){t.r(n),t.d(n,{Head:function(){return s.F},default:function(){return i}});var a=t(7294),o=t(1151);function r(e){const n=Object.assign({span:"span",p:"p",a:"a",h1:"h1",h2:"h2",blockquote:"blockquote",code:"code",pre:"pre"},(0,o.ah)(),e.components);return a.createElement(a.Fragment,null,a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIDBQH/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAgP/2gAMAwEAAhADEAAAAdquNF6aKCM7AdB//8QAHBAAAgICAwAAAAAAAAAAAAAAAQIAAxAREhMx/9oACAEBAAEFAmsCzugOwwK2L5WvFM//xAAXEQEAAwAAAAAAAAAAAAAAAAABAhEg/9oACAEDAQE/ASJWP//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAECAQE/ASP/xAAcEAACAgIDAAAAAAAAAAAAAAAAARExEiAhgZH/2gAIAQEABj8CK8JRlaGuHPZGn//EACEQAAICAQIHAAAAAAAAAAAAAAERACExIEFhcYGRsdHw/9oACAEBAAE/IajJ8QWsOpwACMGGijYYx65xkR8nfjEBZ3t6P//aAAwDAQACAAMAAAAQFz8A/8QAGBEBAAMBAAAAAAAAAAAAAAAAAQAQESH/2gAIAQMBAT8QRqODy//EABgRAAIDAAAAAAAAAAAAAAAAAAABEBEx/9oACAECAQE/EElD2f/EACAQAQACAgIBBQAAAAAAAAAAAAERIQAxQVFhIHGBkbH/2gAIAQEAAT8QbdclJA6StH7hJGD5X0gvxOBgFIjTida5CV8Er2PVRilPgQWqbjW2yaMQtFmySs28vo//2Q==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="ajna"\n        title=""\n        src="/auditor-blog/static/1f800f5d654a35f119e9b878172307a6/27ec1/Ajna.jpg"\n        srcset="/auditor-blog/static/1f800f5d654a35f119e9b878172307a6/46946/Ajna.jpg 240w,\n/auditor-blog/static/1f800f5d654a35f119e9b878172307a6/27ec1/Ajna.jpg 400w"\n        sizes="(max-width: 400px) 100vw, 400px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}}),"\n",a.createElement(n.p,null,"Ajna is a peer to peer, oracleless, permissionless lending protocol with no governance, accepting both fungible and non fungible tokens as collateral."),"\n",a.createElement(n.p,null,"The code was reviewed as part of the ",a.createElement(n.a,{href:"https://app.sherlock.xyz/audits/contests/32"},"Sherlock contest"),".\nIt was the first audit contest I seriously participated in, spending a large amount of my time on the contest."),"\n",a.createElement(n.p,null,"I ranked 11th out of 255 participants in this audit. I found 1 solo medium vulnerabiliy. I present my finding here."),"\n",a.createElement(n.h1,null,"Solo Medium: Quadratic voting tally done wrong"),"\n",a.createElement(n.h2,null,"Summary"),"\n",a.createElement(n.p,null,"Quadratic voting tally is done wrong, which results in a risk of hijacking the grant distribution with relatively low centralization/control over tokens."),"\n",a.createElement(n.h2,null,"Vulnerability Detail"),"\n",a.createElement(n.p,null,"Regarding grant coordination voting of the funding stage, the technical spec states (page24):"),"\n",a.createElement(n.blockquote,null,"\n",a.createElement(n.p,null,"Each address that holds Ajna tokens can vote as much as they want on every proposal, including negative votes, subject to the constraint that the sum of the squares of their votes cannot exceed the square of the number of Ajna tokens held."),"\n"),"\n",a.createElement(n.p,null,"The code enforces that the sum of all votes of a user (in absolute value) is lower or equal than the square of its token holdings. The votes are not squared before being summed."),"\n",a.createElement(n.h2,null,"Impact"),"\n",a.createElement(n.p,null,"This leads to a higher centralization/control risk than should be. Alice can deploy a smart contract that proposes a funding of all the available tokens for that round towards itself. The contract can reward people delegating to it in case of a successful funding."),"\n",a.createElement(n.p,null,"Due to the incorrect tally, if 100 token holders each have 1 token, Alice only needs to convince 10 of them to join her cause to successfully gain the funds. She would receive ",a.createElement(n.code,null,"10^2 = 100")," votes, while all other voters could only produce ",a.createElement(n.code,null,"90 * 1^2 = 90")," votes."),"\n",a.createElement(n.p,null,"If the technical spec were respected and with the same token distribution of 100 tokens split among 100 holders, Alice would need to bribe 50 token holders to join her cause to gain the funding. She has ",a.createElement(n.code,null,"50^2")," voting power and can vote once with",a.createElement(n.code,null,"50")," while all other can vote ",a.createElement(n.code,null,"50 * 1^2 = 50"),"."),"\n",a.createElement(n.p,null,"I consider this difference significant enough to be considered medium severity."),"\n",a.createElement(n.h2,null,"Code Snippet"),"\n",a.createElement(n.p,null,"In ",a.createElement(n.code,null,"StandardFunding.sol")," in ",a.createElement(n.code,null,"_fundingVote()")," the votes for a proposal are counted by adding ",a.createElement(n.code,null,"budgetAllocation_"),":\n",a.createElement(n.a,{href:"https://github.com/sherlock-audit/2023-01-ajna/blob/main/ecosystem-coordination/src/grants/base/StandardFunding.sol#L373"},"https://github.com/sherlock-audit/2023-01-ajna/blob/main/ecosystem-coordination/src/grants/base/StandardFunding.sol#L373")),"\n",a.createElement(n.p,null,"This budget allocation is withdrawn from the voter's voting budget:\n",a.createElement(n.a,{href:"https://github.com/sherlock-audit/2023-01-ajna/blob/main/ecosystem-coordination/src/grants/base/StandardFunding.sol#L358-L368"},"https://github.com/sherlock-audit/2023-01-ajna/blob/main/ecosystem-coordination/src/grants/base/StandardFunding.sol#L358-L368")),"\n",a.createElement(n.p,null,"The initial voting budget is the square of the token holdings at past snapshot:\n",a.createElement(n.a,{href:"https://github.com/sherlock-audit/2023-01-ajna/blob/main/ecosystem-coordination/src/grants/GrantFund.sol#L126-L141"},"https://github.com/sherlock-audit/2023-01-ajna/blob/main/ecosystem-coordination/src/grants/GrantFund.sol#L126-L141")),"\n",a.createElement(n.h2,null,"Tool used"),"\n",a.createElement(n.p,null,"Manual Review"),"\n",a.createElement(n.p,null,"Testing with one person holding 2 tokens beating three persons holding 1 token each:"),"\n",a.createElement("details",null,a.createElement("summary",null,a.createElement(n.p,null,"StandardFundingAttack.t.sol")),a.createElement("p",null,a.createElement(n.pre,null,a.createElement(n.code,{className:"language-solidity"},'// SPDX-License-Identifier: MIT\npragma solidity 0.8.16;\n\nimport { IGovernor } from "@oz/governance/IGovernor.sol";\nimport { IVotes }    from "@oz/governance/utils/IVotes.sol";\nimport { SafeCast }  from "@oz/utils/math/SafeCast.sol";\n\nimport { Funding }          from "../src/grants/base/Funding.sol";\nimport { GrantFund }        from "../src/grants/GrantFund.sol";\nimport { IStandardFunding } from "../src/grants/interfaces/IStandardFunding.sol";\nimport { Maths }            from "../src/grants/libraries/Maths.sol";\n\nimport { GrantFundTestHelper } from "./utils/GrantFundTestHelper.sol";\nimport { IAjnaToken }          from "./utils/IAjnaToken.sol";\n\nimport { console } from "forge-std/console.sol";\n\ncontract StandardFundingGrantFundTest is GrantFundTestHelper {\n\n    // used to cast 256 to uint64 to match emit expectations\n    using SafeCast for uint256;\n\n    IAjnaToken        internal  _token;\n    IVotes            internal  _votingToken;\n    GrantFund         internal  _grantFund;\n\n    // Ajna token Holder at the Ajna contract creation on mainnet\n    address internal _tokenDeployer  = 0x666cf594fB18622e1ddB91468309a7E194ccb799;\n    address internal _tokenHolder1   = makeAddr("_tokenHolder1");\n    address internal _tokenHolder2   = makeAddr("_tokenHolder2");\n    address internal _tokenHolder3   = makeAddr("_tokenHolder3");\n    address internal _tokenHolder4   = makeAddr("_tokenHolder4");\n\n    address[] internal _votersArr = [\n        _tokenHolder1,\n        _tokenHolder2,\n        _tokenHolder3,\n        _tokenHolder4\n    ];\n\n    uint256 _initialAjnaTokenSupply   = 2_000_000_000 * 1e18;\n\n    // at this block on mainnet, all ajna tokens belongs to _tokenDeployer\n    uint256 internal _startBlock      = 16354861;\n\n    mapping (uint256 => uint256) internal noOfVotesOnProposal;\n    uint256[] internal topTenProposalIds;\n    uint256[] internal potentialProposalsSlate;\n    uint256 treasury = 500_000_000 * 1e18;\n\n    function setUp() external {\n        vm.createSelectFork(vm.envString("ETH_RPC_URL"), _startBlock);\n\n        vm.startPrank(_tokenDeployer);\n\n        // Ajna Token contract address on mainnet\n        _token = IAjnaToken(0x9a96ec9B57Fb64FbC60B423d1f4da7691Bd35079);\n\n        // deploy voting token wrapper\n        _votingToken = IVotes(address(_token));\n\n        // deploy growth fund contract\n        _grantFund = new GrantFund(_votingToken, treasury);\n\n        // initial minter distributes tokens to test addresses\n        // _transferAjnaTokens(_token, _votersArr, 50_000_000 * 1e18, _tokenDeployer);\n        changePrank(_tokenDeployer);\n        _token.transfer(_tokenHolder1, 2 * 1e18);\n        _token.transfer(_tokenHolder2, 1 * 1e18);\n        _token.transfer(_tokenHolder3, 1 * 1e18);\n        _token.transfer(_tokenHolder4, 1 * 1e18);\n\n        // initial minter distributes treasury to grantFund\n        _token.transfer(address(_grantFund), treasury);\n    }\n\n    /*************/\n    /*** Tests ***/\n    /*************/\n\n    function testQuadraticVotingTally() external {\n        _selfDelegateVoters(_token, _votersArr);\n\n        vm.roll(_startBlock + 50);\n\n        // start distribution period\n        _startDistributionPeriod(_grantFund);\n        uint256 distributionId = _grantFund.getDistributionId();\n        (, , , , uint256 gbc, ) = _grantFund.getDistributionPeriodInfo(distributionId);\n\n        // generate proposal targets\n        address[] memory ajnaTokenTargets = new address[](1);\n        ajnaTokenTargets[0] = address(_token);\n\n        // generate proposal values\n        uint256[] memory values = new uint256[](1);\n        values[0] = 0;\n\n        // generate proposal calldata\n        bytes[] memory proposalCalldata = new bytes[](1);\n        proposalCalldata[0] = abi.encodeWithSignature(\n            "transfer(address,uint256)",\n            _tokenHolder1,\n            gbc * 8/10\n        );\n        bytes[] memory proposalCalldata2 = new bytes[](1);\n        proposalCalldata2[0] = abi.encodeWithSignature(\n            "transfer(address,uint256)",\n            _tokenHolder2,\n            gbc * 7/10\n        );\n\n        // create and submit proposal\n        TestProposal memory proposal = _createProposalStandard(_grantFund, _tokenHolder1, ajnaTokenTargets, values, proposalCalldata, "Proposal for Ajna token transfer to tester address");\n        TestProposal memory proposal2 = _createProposalStandard(_grantFund, _tokenHolder2, ajnaTokenTargets, values, proposalCalldata2, "Proposal 2 for Ajna token transfer to tester address");\n\n        vm.roll(_startBlock + 200);\n\n        // screening period votes\n        _vote(_grantFund, _tokenHolder1, proposal.proposalId, voteYes, 1);\n        _vote(_grantFund, _tokenHolder2, proposal2.proposalId, voteYes, 1);\n\n        // skip forward to the funding stage\n        vm.roll(_startBlock + 600_000);\n\n        GrantFund.Proposal[] memory screenedProposals = _getProposalListFromProposalIds(_grantFund, _grantFund.getTopTenProposals(distributionId));\n        assertEq(screenedProposals.length, 2);\n        assertEq(screenedProposals[0].proposalId, proposal.proposalId);\n        assertEq(screenedProposals[0].votesReceived, 2 * 1e18);\n        assertEq(screenedProposals[1].proposalId, proposal2.proposalId);\n        assertEq(screenedProposals[1].votesReceived, 1 * 1e18);\n\n        // check initial voting power\n        uint256 votingPower = _grantFund.getVotesWithParams(_tokenHolder1, block.number, "Funding");\n        assertEq(votingPower, 4 * 1e18);\n        votingPower = _grantFund.getVotesWithParams(_tokenHolder2, block.number, "Funding");\n        assertEq(votingPower, 1 * 1e18);\n        votingPower = _grantFund.getVotesWithParams(_tokenHolder3, block.number, "Funding");\n        assertEq(votingPower, 1 * 1e18);\n        votingPower = _grantFund.getVotesWithParams(_tokenHolder4, block.number, "Funding");\n        assertEq(votingPower, 1 * 1e18);\n\n        _fundingVote(_grantFund, _tokenHolder1, proposal.proposalId, voteYes, 4 * 1e18);\n        _fundingVote(_grantFund, _tokenHolder2, proposal2.proposalId, voteYes, 1 * 1e18);\n        _fundingVote(_grantFund, _tokenHolder3, proposal2.proposalId, voteYes, 1 * 1e18);\n        _fundingVote(_grantFund, _tokenHolder4, proposal2.proposalId, voteYes, 1 * 1e18);\n        \n        // check voting power after voting\n        votingPower = _grantFund.getVotesWithParams(_tokenHolder1, block.number, "Funding");\n        assertEq(votingPower, 0 * 1e18);\n        votingPower = _grantFund.getVotesWithParams(_tokenHolder2, block.number, "Funding");\n        assertEq(votingPower, 0 * 1e18);\n        votingPower = _grantFund.getVotesWithParams(_tokenHolder3, block.number, "Funding");\n        assertEq(votingPower, 0 * 1e18);\n        votingPower = _grantFund.getVotesWithParams(_tokenHolder4, block.number, "Funding");\n        assertEq(votingPower, 0 * 1e18);\n\n        // skip to the DistributionPeriod\n        vm.roll(_startBlock + 650_000);\n\n        uint256[] memory winningSlate = new uint256[](1);\n        winningSlate[0] = proposal.proposalId;\n        uint256[] memory losingSlate = new uint256[](1);\n        losingSlate[0] = proposal2.proposalId;\n\n        // The losing slate is valid\n        assertTrue(_grantFund.checkSlate(losingSlate, distributionId));\n        // The winning slate is valid and has more votes than the losing slate\n        assertTrue(_grantFund.checkSlate(winningSlate, distributionId));\n    }\n}\n')))),"\n",a.createElement(n.h2,null,"Recommendation"),"\n",a.createElement(n.p,null,"Subtract the square of the votes from the voting budget when voting:"),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-solidity"},"@@ -357,17 +361,10 @@ abstract contract StandardFunding is Funding, IStandardFunding {\n         // case where voter is voting against the proposal\n         if (budgetAllocation_ < 0) {\n             support = 0;\n-\n-            // update voter budget remaining\n-            voter_.budgetRemaining += budgetAllocation_;\n-        }\n-        // voter is voting in support of the proposal\n-        else {\n-            // update voter budget remaining\n-            voter_.budgetRemaining -= budgetAllocation_;\n         }\n+        voter_.budgetRemaining -= int256(Maths.wpow(uint256(Maths.abs(budgetAllocation_)), 2));\n         // update total vote cast\n         currentDistribution.quadraticVotesCast += uint256(Maths.abs(budgetAllocation_));\n\n         // update proposal vote tracking\n         proposal_.qvBudgetAllocated += budgetAllocation_;\n")))}var l=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,o.ah)(),e.components);return n?a.createElement(n,e,a.createElement(r,e)):r(e)},s=t(4765);function i(e){return a.createElement(s.Z,e,a.createElement(l,e))}s.Z}}]);
//# sourceMappingURL=component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-content-file-path-content-posts-ajna-report-index-mdx-ef679ccc4225f03e894b.js.map